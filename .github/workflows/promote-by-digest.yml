name: Promote by Digest

on:
  workflow_dispatch:
    inputs:
      sourceRepo:
        description: "Source repo (e.g., docker.io/ORG/APP-stage)"
        required: true
      sourceDigest:
        description: "Digest to promote (e.g., sha256:abcd...)"
        required: true
      targetRepo:
        description: "Target repo (e.g., docker.io/ORG/APP-prod)"
        required: true
      targetTag:
        description: "Tag to apply (e.g., stable)"
        required: true

jobs:
  promote:
    runs-on: ubuntu-latest
    environment: prod
    steps:
    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Install crane
      run: |
        curl -L https://github.com/google/go-containerregistry/releases/latest/download/crane_$(uname -s)_$(uname -m).tar.gz \
          | tar -xz crane
        sudo mv crane /usr/local/bin/

    - name: Promote
      run: |
        crane copy "${{ github.event.inputs.sourceRepo }}@${{ github.event.inputs.sourceDigest }}" \
                   "${{ github.event.inputs.targetRepo }}:${{ github.event.inputs.targetTag }}"
